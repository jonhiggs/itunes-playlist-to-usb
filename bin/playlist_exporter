#!/usr/bin/env ruby
require 'thor'
require File.join(File.dirname(__FILE__), "../lib/itunes-playlist-to-usb")

class PlaylistExporter < Thor
  desc "process", "process playlist"
  method_option :quiet, :type => :boolean, :default => false, :aliases => "-q", :desc => "don't show the progress bar."
  method_option :debug, :type => :boolean, :default => false, :aliases => "-d", :desc => "enable debugging"
  def process
    PROGRESS_BAR.verbose = !options.quiet?
    PROGRESS_BAR.debug = options.debug?

    xml = File.read(SETTINGS["playlist"])
    @playlist = PL2USB::Playlist.new(xml)

    PROGRESS_BAR.total = @playlist.tracks.count

    @playlist.tracks(:type=>"lossy").each do |track|
      track.save
      PROGRESS_BAR.increment
    end

    @playlist.tracks(:type=>"lossless").each do |track|
      track.save
      PROGRESS_BAR.increment
    end
  end

  desc "verify", "validate files in library"
  method_option :debug, :type => :boolean, :default => false, :aliases => "-d", :desc => "enable debug mode."
  method_option :quiet, :type => :boolean, :default => false, :aliases => "-q", :desc => "don't show the progress bar."
  def verify
    PROGRESS_BAR.verbose = !options.quiet?
    PROGRESS_BAR.debug = options.debug?

    @playlist = PL2USB::Playlist.new(File.read(SETTINGS["playlist"]))
    PROGRESS_BAR.total = @playlist.tracks.count

    # start with the tracks that don't need compressing.
    @playlist.tracks.each do |track|
      track.valid?
      PROGRESS_BAR.increment
    end
  end

end

PlaylistExporter.start
